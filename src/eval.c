/**
 * @file eval.c
 *
 * Evaluation function.
 *
 * @date 1998 - 2023
 * @author Richard Delorme
 * @author Toshihiko Okuhara
 * @version 4.5
 */

#include "eval.h"

#include "bit.h"
#include "board.h"
#include "options.h"
#include "move.h"
#include "util.h"

#include <stdlib.h>
#include <assert.h>

#if !defined(VECTOR_EVAL_UPDATE) && !defined(hasSSE2) && !defined(__ARM_NEON)

/** coordinate to feature conversion */
typedef struct CoordinateToFeature {
	int n_feature;
	struct {
		unsigned short i;
		unsigned short x;
	} feature[7];
} CoordinateToFeature;

/** feature to coordinates conversion */
typedef struct FeatureToCoordinate {
	int n_square;
	unsigned char x[12];
} FeatureToCoordinate;

/** array to convert features into coordinates */
static const FeatureToCoordinate EVAL_F2X[] = {
	{ 9, {A1, B1, A2, B2, C1, A3, C2, B3, C3}},
	{ 9, {H1, G1, H2, G2, F1, H3, F2, G3, F3}},
	{ 9, {A8, A7, B8, B7, A6, C8, B6, C7, C6}},
	{ 9, {H8, H7, G8, G7, H6, F8, G6, F7, F6}},

	{10, {A5, A4, A3, A2, A1, B2, B1, C1, D1, E1}},
	{10, {H5, H4, H3, H2, H1, G2, G1, F1, E1, D1}},
	{10, {A4, A5, A6, A7, A8, B7, B8, C8, D8, E8}},
	{10, {H4, H5, H6, H7, H8, G7, G8, F8, E8, D8}},

	{10, {B2, A1, B1, C1, D1, E1, F1, G1, H1, G2}},
	{10, {B7, A8, B8, C8, D8, E8, F8, G8, H8, G7}},
	{10, {B2, A1, A2, A3, A4, A5, A6, A7, A8, B7}},
	{10, {G2, H1, H2, H3, H4, H5, H6, H7, H8, G7}},

	{10, {A1, C1, D1, C2, D2, E2, F2, E1, F1, H1}},
	{10, {A8, C8, D8, C7, D7, E7, F7, E8, F8, H8}},
	{10, {A1, A3, A4, B3, B4, B5, B6, A5, A6, A8}},
	{10, {H1, H3, H4, G3, G4, G5, G6, H5, H6, H8}},

	{ 8, {A2, B2, C2, D2, E2, F2, G2, H2}},
	{ 8, {A7, B7, C7, D7, E7, F7, G7, H7}},
	{ 8, {B1, B2, B3, B4, B5, B6, B7, B8}},
	{ 8, {G1, G2, G3, G4, G5, G6, G7, G8}},

	{ 8, {A3, B3, C3, D3, E3, F3, G3, H3}},
	{ 8, {A6, B6, C6, D6, E6, F6, G6, H6}},
	{ 8, {C1, C2, C3, C4, C5, C6, C7, C8}},
	{ 8, {F1, F2, F3, F4, F5, F6, F7, F8}},

	{ 8, {A4, B4, C4, D4, E4, F4, G4, H4}},
	{ 8, {A5, B5, C5, D5, E5, F5, G5, H5}},
	{ 8, {D1, D2, D3, D4, D5, D6, D7, D8}},
	{ 8, {E1, E2, E3, E4, E5, E6, E7, E8}},

	{ 8, {A1, B2, C3, D4, E5, F6, G7, H8}},
	{ 8, {A8, B7, C6, D5, E4, F3, G2, H1}},

	{ 7, {B1, C2, D3, E4, F5, G6, H7}},
	{ 7, {H2, G3, F4, E5, D6, C7, B8}},
	{ 7, {A2, B3, C4, D5, E6, F7, G8}},
	{ 7, {G1, F2, E3, D4, C5, B6, A7}},

	{ 6, {C1, D2, E3, F4, G5, H6}},
	{ 6, {A3, B4, C5, D6, E7, F8}},
	{ 6, {F1, E2, D3, C4, B5, A6}},
	{ 6, {H3, G4, F5, E6, D7, C8}},

	{ 5, {D1, E2, F3, G4, H5}},
	{ 5, {A4, B5, C6, D7, E8}},
	{ 5, {E1, D2, C3, B4, A5}},
	{ 5, {H4, G5, F6, E7, D8}},

	{ 4, {D1, C2, B3, A4}},
	{ 4, {A5, B6, C7, D8}},
	{ 4, {E1, F2, G3, H4}},
	{ 4, {H5, G6, F7, E8}},

	{ 0, {NOMOVE}}
};

/** array to convert coordinates into feature */
static const CoordinateToFeature EVAL_X2F[] = {
	{7, {{ 0,  6561}, { 4,   243}, { 8,  6561}, {10,  6561}, {12, 19683}, {14, 19683}, {28,  2187}}},  /* a1 */
	{5, {{ 0,  2187}, { 4,    27}, { 8,  2187}, {18,  2187}, {30,   729}}},                            /* b1 */
	{6, {{ 0,    81}, { 4,     9}, { 8,   729}, {12,  6561}, {22,  2187}, {34,   243}}},               /* c1 */
	{7, {{ 4,     3}, { 5,     1}, { 8,   243}, {12,  2187}, {26,  2187}, {38,    81}, {42,    27}}},  /* d1 */
	{7, {{ 4,     1}, { 5,     3}, { 8,    81}, {12,     9}, {27,  2187}, {40,    81}, {44,    27}}},  /* e1 */
	{6, {{ 1,    81}, { 5,     9}, { 8,    27}, {12,     3}, {23,  2187}, {36,   243}}},               /* f1 */
	{5, {{ 1,  2187}, { 5,    27}, { 8,     9}, {19,  2187}, {33,   729}}},                            /* g1 */
	{7, {{ 1,  6561}, { 5,   243}, { 8,     3}, {11,  6561}, {12,     1}, {15, 19683}, {29,     1}}},  /* h1 */
	{5, {{ 0,   729}, { 4,   729}, {10,  2187}, {16,  2187}, {32,   729}}},                            /* a2 */
	{7, {{ 0,   243}, { 4,    81}, { 8, 19683}, {10, 19683}, {16,   729}, {18,   729}, {28,   729}}},  /* b2 */
	{6, {{ 0,     9}, {12,   729}, {16,   243}, {22,   729}, {30,   243}, {42,     9}}},               /* c2 */
	{5, {{12,   243}, {16,    81}, {26,   729}, {34,    81}, {40,    27}}},                            /* d2 */
	{5, {{12,    81}, {16,    27}, {27,   729}, {36,    81}, {38,    27}}},                            /* e2 */
	{6, {{ 1,     9}, {12,    27}, {16,     9}, {23,   729}, {33,   243}, {44,     9}}},               /* f2 */
	{7, {{ 1,   243}, { 5,    81}, { 8,     1}, {11, 19683}, {16,     3}, {19,   729}, {29,     3}}},  /* g2 */
	{5, {{ 1,   729}, { 5,   729}, {11,  2187}, {16,     1}, {31,   729}}},                            /* h2 */
	{6, {{ 0,    27}, { 4,  2187}, {10,   729}, {14,  6561}, {20,  2187}, {35,   243}}},               /* a3 */
	{6, {{ 0,     3}, {14,   729}, {18,   243}, {20,   729}, {32,   243}, {42,     3}}},               /* b3 */
	{5, {{ 0,     1}, {20,   243}, {22,   243}, {28,   243}, {40,     9}}},                            /* c3 */
	{4, {{20,    81}, {26,   243}, {30,    81}, {36,    27}}},                                         /* d3 */
	{4, {{20,    27}, {27,   243}, {33,    81}, {34,    27}}},                                         /* e3 */
	{5, {{ 1,     1}, {20,     9}, {23,   243}, {29,     9}, {38,     9}}},                            /* f3 */
	{6, {{ 1,     3}, {15,   729}, {19,   243}, {20,     3}, {31,   243}, {44,     3}}},               /* g3 */
	{6, {{ 1,    27}, { 5,  2187}, {11,   729}, {15,  6561}, {20,     1}, {37,   243}}},               /* h3 */
	{7, {{ 4,  6561}, { 6, 19683}, {10,   243}, {14,  2187}, {24,  2187}, {39,    81}, {42,     1}}},  /* a4 */
	{5, {{14,   243}, {18,    81}, {24,   729}, {35,    81}, {40,     3}}},                            /* b4 */
	{4, {{22,    81}, {24,   243}, {32,    81}, {36,     9}}},                                         /* c4 */
	{4, {{24,    81}, {26,    81}, {28,    81}, {33,    27}}},                                         /* d4 */
	{4, {{24,    27}, {27,    81}, {29,    27}, {30,    27}}},                                         /* e4 */
	{4, {{23,    81}, {24,     9}, {31,    81}, {34,     9}}},                                         /* f4 */
	{5, {{15,   243}, {19,    81}, {24,     3}, {37,    81}, {38,     3}}},                            /* g4 */
	{7, {{ 5,  6561}, { 7, 19683}, {11,   243}, {15,  2187}, {24,     1}, {41,    81}, {44,     1}}},  /* h4 */
	{7, {{ 4, 19683}, { 6,  6561}, {10,    81}, {14,     9}, {25,  2187}, {40,     1}, {43,    27}}},  /* a5 */
	{5, {{14,    81}, {18,    27}, {25,   729}, {36,     3}, {39,    27}}},                            /* b5 */
	{4, {{22,    27}, {25,   243}, {33,     9}, {35,    27}}},                                         /* c5 */
	{4, {{25,    81}, {26,    27}, {29,    81}, {32,    27}}},                                         /* d5 */
	{4, {{25,    27}, {27,    27}, {28,    27}, {31,    27}}},                                         /* e5 */
	{4, {{23,    27}, {25,     9}, {30,     9}, {37,    27}}},                                         /* f5 */
	{5, {{15,    81}, {19,    27}, {25,     3}, {34,     3}, {41,    27}}},                            /* g5 */
	{7, {{ 5, 19683}, { 7,  6561}, {11,    81}, {15,     9}, {25,     1}, {38,     1}, {45,    27}}},  /* h5 */
	{6, {{ 2,    81}, { 6,  2187}, {10,    27}, {14,     3}, {21,  2187}, {36,     1}}},               /* a6 */
	{6, {{ 2,     9}, {14,    27}, {18,     9}, {21,   729}, {33,     3}, {43,     9}}},               /* b6 */
	{5, {{ 2,     1}, {21,   243}, {22,     9}, {29,   243}, {39,     9}}},                            /* c6 */
	{4, {{21,    81}, {26,     9}, {31,     9}, {35,     9}}},                                         /* d6 */
	{4, {{21,    27}, {27,     9}, {32,     9}, {37,     9}}},                                         /* e6 */
	{5, {{ 3,     1}, {21,     9}, {23,     9}, {28,     9}, {41,     9}}},                            /* f6 */
	{6, {{ 3,     9}, {15,    27}, {19,     9}, {21,     3}, {30,     3}, {45,     9}}},               /* g6 */
	{6, {{ 3,    81}, { 7,  2187}, {11,    27}, {15,     3}, {21,     1}, {34,     1}}},               /* h6 */
	{5, {{ 2,  2187}, { 6,   729}, {10,     9}, {17,  2187}, {33,     1}}},                            /* a7 */
	{7, {{ 2,   243}, { 6,    81}, { 9, 19683}, {10,     1}, {17,   729}, {18,     3}, {29,   729}}},  /* b7 */
	{6, {{ 2,     3}, {13,   729}, {17,   243}, {22,     3}, {31,     3}, {43,     3}}},               /* c7 */
	{5, {{13,   243}, {17,    81}, {26,     3}, {37,     3}, {39,     3}}},                            /* d7 */
	{5, {{13,    81}, {17,    27}, {27,     3}, {35,     3}, {41,     3}}},                            /* e7 */
	{6, {{ 3,     3}, {13,    27}, {17,     9}, {23,     3}, {32,     3}, {45,     3}}},               /* f7 */
	{7, {{ 3,   243}, { 7,    81}, { 9,     1}, {11,     1}, {17,     3}, {19,     3}, {28,     3}}},  /* g7 */
	{5, {{ 3,  2187}, { 7,   729}, {11,     9}, {17,     1}, {30,     1}}},                            /* h7 */
	{7, {{ 2,  6561}, { 6,   243}, { 9,  6561}, {10,     3}, {13, 19683}, {14,     1}, {29,  2187}}},  /* a8 */
	{5, {{ 2,   729}, { 6,    27}, { 9,  2187}, {18,     1}, {31,     1}}},                            /* b8 */
	{6, {{ 2,    27}, { 6,     9}, { 9,   729}, {13,  6561}, {22,     1}, {37,     1}}},               /* c8 */
	{7, {{ 6,     3}, { 7,     1}, { 9,   243}, {13,  2187}, {26,     1}, {41,     1}, {43,     1}}},  /* d8 */
	{7, {{ 6,     1}, { 7,     3}, { 9,    81}, {13,     9}, {27,     1}, {39,     1}, {45,     1}}},  /* e8 */
	{6, {{ 3,    27}, { 7,     9}, { 9,    27}, {13,     3}, {23,     1}, {35,     1}}},               /* f8 */
	{5, {{ 3,   729}, { 7,    27}, { 9,     9}, {19,     1}, {32,     1}}},                            /* g8 */
	{7, {{ 3,  6561}, { 7,   243}, { 9,     3}, {11,     3}, {13,     1}, {15,     1}, {28,     1}}},  /* h8 */
	{4, {{ 0,     0}, { 0,     0}, { 0,     0}, { 0,     0}}} // <- PASS
};

#endif
#if defined(VECTOR_EVAL_UPDATE) || defined(hasSSE2) || defined(__ARM_NEON) || defined(DISPATCH_NEON) || defined(USE_GAS_MMX) || defined(USE_MSVC_X86)

const EVAL_FEATURE_V EVAL_FEATURE[65] = {
	{{ // a1
		 6561,     0,     0,     0,   243,     0,     0,     0,  6561,     0,  6561,     0, 19683,     0, 19683,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // b1
		 2187,     0,     0,     0,    27,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // c1
		   81,     0,     0,     0,     9,     0,     0,     0,   729,     0,     0,     0,  6561,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,   243,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // d1
		    0,     0,     0,     0,     3,     1,     0,     0,   243,     0,     0,     0,  2187,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,    81,     0,     0,     0,    27,     0,     0,     0,     0,     0
	}}, {{ // e1
		    0,     0,     0,     0,     1,     3,     0,     0,    81,     0,     0,     0,     9,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,    81,     0,     0,     0,    27,     0,     0,     0
	}}, {{ // f1
		    0,    81,     0,     0,     0,     9,     0,     0,    27,     0,     0,     0,     3,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,   243,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // g1
		    0,  2187,     0,     0,     0,    27,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,   729,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // h1
		    0,  6561,     0,     0,     0,   243,     0,     0,     3,     0,     0,  6561,     1,     0,     0, 19683,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // a2
		  729,     0,     0,     0,   729,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,
		 2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		  729,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // b2
		  243,     0,     0,     0,    81,     0,     0,     0, 19683,     0, 19683,     0,     0,     0,     0,     0,
		  729,     0,   729,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // c2
		    9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,     0,     0,
		  243,     0,     0,     0,     0,     0,   729,     0,     0,     0,     0,     0,     0,     0,   243,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0,     0
	}}, {{ // d2
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   243,     0,     0,     0,
		   81,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,     0,     0,     0,     0,
		    0,     0,    81,     0,     0,     0,     0,     0,    27,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // e2
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    81,     0,     0,     0,
		   27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,     0,     0,     0,
		    0,     0,     0,     0,    81,     0,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // f2
		    0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    27,     0,     0,     0,
		    9,     0,     0,     0,     0,     0,     0,   729,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,   243,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     9,     0,     0,     0
	}}, {{ // g2
		    0,   243,     0,     0,     0,    81,     0,     0,     1,     0,     0, 19683,     0,     0,     0,     0,
		    3,     0,     0,   729,     0,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // h2
		    0,   729,     0,     0,     0,   729,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,
		    1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // a3
		   27,     0,     0,     0,  2187,     0,     0,     0,     0,     0,   729,     0,     0,     0,  6561,     0,
		    0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,   243,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // b3
		    3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,
		    0,     0,   243,     0,   729,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		  243,     0,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0
	}}, {{ // c3
		    1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,   243,     0,   243,     0,     0,     0,     0,     0,   243,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // d3
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,    81,     0,     0,     0,     0,     0,   243,     0,     0,     0,    81,     0,
		    0,     0,     0,     0,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // e3
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,    27,     0,     0,     0,     0,     0,     0,   243,     0,     0,     0,     0,
		    0,    81,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // f3
		    0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     9,     0,     0,   243,     0,     0,     0,     0,     0,     9,     0,     0,
		    0,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // g3
		    0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,
		    0,     0,     0,   243,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   243,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,     0
	}}, {{ // h3
		    0,    27,     0,     0,     0,  2187,     0,     0,     0,     0,     0,   729,     0,     0,     0,  6561,
		    0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,   243,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // a4
		    0,     0,     0,     0,  6561,     0, 19683,     0,     0,     0,   243,     0,     0,     0,  2187,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,    81,     0,     0,     1,     0,     0,     0,     0,     0
	}}, {{ // b4
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   243,     0,
		    0,     0,    81,     0,     0,     0,     0,     0,   729,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,    81,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // c4
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,    81,     0,   243,     0,     0,     0,     0,     0,     0,     0,
		   81,     0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // d4
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,    81,     0,    81,     0,    81,     0,     0,     0,
		    0,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // e4
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,    27,     0,     0,    81,     0,    27,    27,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // f4
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,    81,     9,     0,     0,     0,     0,     0,     0,    81,
		    0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // g4
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   243,
		    0,     0,     0,    81,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,    81,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // h4
		    0,     0,     0,     0,     0,  6561,     0, 19683,     0,     0,     0,   243,     0,     0,     0,  2187,
		    0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,    81,     0,     0,     1,     0,     0,     0
	}}, {{ // a5
		    0,     0,     0,     0, 19683,     0,  6561,     0,     0,     0,    81,     0,     0,     0,     9,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,    27,     0,     0,     0,     0
	}}, {{ // b5
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    81,     0,
		    0,     0,    27,     0,     0,     0,     0,     0,     0,   729,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     3,     0,     0,    27,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // c5
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,    27,     0,     0,   243,     0,     0,     0,     0,     0,     0,
		    0,     9,     0,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // d5
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,    81,    27,     0,     0,    81,     0,     0,
		   27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // e5
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,    27,     0,    27,    27,     0,     0,    27,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // f5
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,    27,     0,     9,     0,     0,     0,     0,     9,     0,
		    0,     0,     0,     0,     0,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // g5
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    81,
		    0,     0,     0,    27,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,     0,
		    0,     0,     3,     0,     0,     0,     0,     0,     0,    27,     0,     0,     0,     0,     0,     0
	}}, {{ // h5
		    0,     0,     0,     0,     0, 19683,     0,  6561,     0,     0,     0,    81,     0,     0,     0,     9,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,    27,     0,     0
	}}, {{ // a6
		    0,     0,    81,     0,     0,     0,  2187,     0,     0,     0,    27,     0,     0,     0,     3,     0,
		    0,     0,     0,     0,     0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // b6
		    0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    27,     0,
		    0,     0,     9,     0,     0,   729,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0
	}}, {{ // c6
		    0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,   243,     9,     0,     0,     0,     0,     0,     0,   243,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // d6
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,    81,     0,     0,     0,     0,     9,     0,     0,     0,     0,     9,
		    0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // e6
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,    27,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0,
		    9,     0,     0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // f6
		    0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     9,     0,     9,     0,     0,     0,     0,     9,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     9,     0,     0,     0,     0,     0,     0
	}}, {{ // g6
		    0,     0,     0,     9,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    27,
		    0,     0,     0,     9,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     9,     0,     0
	}}, {{ // h6
		    0,     0,     0,    81,     0,     0,     0,  2187,     0,     0,     0,    27,     0,     0,     0,     3,
		    0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // a7
		    0,     0,  2187,     0,     0,     0,   729,     0,     0,     0,     9,     0,     0,     0,     0,     0,
		    0,  2187,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // b7
		    0,     0,   243,     0,     0,     0,    81,     0,     0, 19683,     1,     0,     0,     0,     0,     0,
		    0,   729,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // c7
		    0,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   729,     0,     0,
		    0,   243,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     3,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0
	}}, {{ // d7
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,   243,     0,     0,
		    0,    81,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     3,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // e7
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,    81,     0,     0,
		    0,    27,     0,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0,
		    0,     0,     0,     3,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,     0
	}}, {{ // f7
		    0,     0,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     0,    27,     0,     0,
		    0,     9,     0,     0,     0,     0,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0,
		    3,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0
	}}, {{ // g7
		    0,     0,     0,   243,     0,     0,     0,    81,     0,     1,     0,     1,     0,     0,     0,     0,
		    0,     3,     0,     3,     0,     0,     0,     0,     0,     0,     0,     0,     3,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // h7
		    0,     0,     0,  2187,     0,     0,     0,   729,     0,     0,     0,     9,     0,     0,     0,     0,
		    0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // a8
		    0,     0,  6561,     0,     0,     0,   243,     0,     0,  6561,     3,     0,     0, 19683,     1,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,  2187,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // b8
		    0,     0,   729,     0,     0,     0,    27,     0,     0,  2187,     0,     0,     0,     0,     0,     0,
		    0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     1,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // c8
		    0,     0,    27,     0,     0,     0,     9,     0,     0,   729,     0,     0,     0,  6561,     0,     0,
		    0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // d8
		    0,     0,     0,     0,     0,     0,     3,     1,     0,   243,     0,     0,     0,  2187,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     1,     0,     0,     0,     0
	}}, {{ // e8
		    0,     0,     0,     0,     0,     0,     1,     3,     0,    81,     0,     0,     0,     9,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     1,     0,     0
	}}, {{ // f8
		    0,     0,     0,    27,     0,     0,     0,     9,     0,    27,     0,     0,     0,     3,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // g8
		    0,     0,     0,   729,     0,     0,     0,    27,     0,     9,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    1,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // h8
		    0,     0,     0,  6561,     0,     0,     0,   243,     0,     3,     0,     3,     0,     1,     0,     1,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     1,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}, {{ // PASS
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
		    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0
	}}
};

const EVAL_FEATURE_V EVAL_FEATURE_all_opponent = {{
	 9841,  9841,  9841,  9841, 29524, 29524, 29524, 29524, 29524, 29524, 29524, 29524, 29524, 29524, 29524, 29524,
//	11111111(3)                 +3^8                       +3^8*2                      +3^8*3         1111111(3)
	 3280,  3280,  3280,  3280,  9841,  9841,  9841,  9841, 16402, 16402, 16402, 16402, 22963, 22963,  1093,  1093,
//	              364(=111111(3))+2187        121(=11111(3))+2187+729     40(=1111(3))+2187+729+243
	 1093,  1093,  2551,  2551,  2551,  2551,  3037,  3037,  3037,  3037,  3199,  3199,  3199,  3199,     0,     0
}};

#endif

/** feature offset/size */
// static const int EVAL_OFS[] = { 0, 19683, 78732, 137781, 196830, 203391, 209952, 216513, 223074, 225261, 225990, 226233, 226314 };
// static const int EVAL_SIZE[] = {19683, 59049, 59049, 59049, 6561, 6561, 6561, 6561, 2187, 729, 243, 81, 1};
static const unsigned short EVAL_OFFSET[] = {
	    0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
	    0,     0,     0,     0,  6561,  6561,  6561,  6561, 13122, 13122, 13122, 13122, 19683, 19683,     0,     0,
	    0,     0,  2187,  2187,  2187,  2187,  2916,  2916,  2916,  2916,  3159,  3159,  3159,  3159,     0,     0
};

/** packed feature offset/size */
static const int EVAL_PACKED_OFS[] = { 0, 10206, 40095, 69741, 99387, 102708, 106029, 109350, 112671, 113805, 114183, 114318, 114363 };
// static const int EVAL_PACKED_SIZE[] = {10206, 29889, 29646, 29646, 3321, 3321, 3321, 3321, 1134, 378, 135, 45, 1};

/** feature symetry packing */
typedef struct {
	short EVAL_C10[59049];
	short EVAL_S10[59049];
	short EVAL_C9[19683];
	short EVAL_S8[6561];
	short EVAL_S7[2187];
	short EVAL_S6[729];
	short EVAL_S5[243];
	short EVAL_S4[81];
} SymetryPacking;

/** eval weight load status */
static int EVAL_LOADED = 0;

/** eval weights */
Eval_weight (*EVAL_WEIGHT)[EVAL_N_PLY - 2];	// for 2..53

/** opponent feature */
static unsigned short *OPPONENT_FEATURE;

/** evaluation function error coefficient parameters */
static double EVAL_A, EVAL_B, EVAL_C, EVAL_a, EVAL_b, EVAL_c;

/**
 * @brief Opponent feature.
 *
 * Compute a feature from the opponent point of view.
 * @param p opponent feature pointer.
 * @param o opponent feature base to next depth.
 * @param d feature size.
 * @return updated opponent feature pointer
 */
// #define OPPONENT(x)	((9 >> (x)) & 3)	// (0, 1, 2) to (1, 0, 2)
static unsigned short *set_opponent_feature(unsigned short *p, int o, int d)
{
	if (--d) {
		p = set_opponent_feature(p, (o + 1) * 3, d);
		p = set_opponent_feature(p, o * 3, d);
		p = set_opponent_feature(p, (o + 2) * 3, d);
	} else {
		*p++ = o + 1;
		*p++ = o;
		*p++ = o + 2;
	}
	return p;
}

/**
 * @brief Create eval packing index.
 *
 * Create an index array to reduce mirror positions.
 * @param pe pointer to array to set result.
 * @param T internally used array to check mirror positions.
 * @param kd feature increment at each depth for the mirror position.
 * @param l feature index.
 * @param k feature index for the mirror position.
 * @param n packed count so far.
 * @param d feature size, >= 4.
 * @return updated packed count.
 */
static int set_eval_packing(short *pe, int *T, const int *kd, int l, int k, int n, int d)
{
	int	i, q0, q1, q2, q3;

	if (--d > 3) {
		l *= 3;
		n = set_eval_packing(pe, T, kd, l, k, n, d);
		k += kd[d];
		n = set_eval_packing(pe, T, kd, l + 3, k, n, d);
		k += kd[d];
		n = set_eval_packing(pe, T, kd, l + 6, k, n, d);
	} else {
		l *= 27;
		for (q3 = 0; q3 < 3; ++q3) {
			for (q2 = 0; q2 < 3; ++q2) {
				for (q1 = 0; q1 < 3; ++q1) {
					for (q0 = 0; q0 < 3; ++q0) {
						if (k < l) i = T[k];
						else T[l] = i = n++;
						pe[l++] = i;
						k += kd[0];
					}
					k += (kd[1] - kd[0] * 3);
				}
				k += (kd[2] - kd[1] * 3);
			}
			k += (kd[3] - kd[2] * 3);
		}
	}
	return n;
}

/**
 * @brief Load the evaluation function features' weights.
 *
 * The weights are stored in a global variable, because, once loaded from the
 * file, they stay constant during the lifetime of the program. As loading
 * the weights is time & resource consuming, a counter variable check that
 * the weights are effectively loaded only once.
 *
 * @param file File name of the evaluation function data.
 */
void eval_open(const char* file)
{
	unsigned int edax_header, eval_header;
	unsigned int version, release, build;
	double date;
	const int n_w = 114364;
	int *T;
	int ply, i, j, k;
	int r;
	FILE* f;
	short *w;
	Eval_weight *pe;
	SymetryPacking (*P)[2];
	SymetryPacking *pp;
	static const int kd_S10[] = { 19683, 6561, 2187, 729, 243, 81, 27, 9, 3, 1 };
	static const int kd_C10[] = { 19683, 6561, 2187, 729, 81, 243, 27, 9, 3, 1 };
	static const int kd_C9[] = { 1, 9, 3, 81, 27, 243, 2187, 729, 6561 };

	if (EVAL_LOADED++) return;

	// the following is assumed:
	//	-(unsigned) int are 32 bits
	if (sizeof (int) != 4) fatal_error("int size is not compatible with Edax.\n");
	//	-(unsigned) short are 16 bits
	if (sizeof (short) != 2) fatal_error("short size is not compatible with Edax.\n");

	// create unpacking tables
	OPPONENT_FEATURE = (unsigned short *) malloc(59049 * sizeof(unsigned short));	// 3^10
	P = (SymetryPacking (*)[2]) malloc(2 * sizeof(*P));
	T = (int *) malloc(2 * 59049 * sizeof(*T));
	if ((OPPONENT_FEATURE == NULL) || (P == NULL) || (T == NULL))
		fatal_error("Cannot allocate temporary table variable.\n");

	set_opponent_feature(OPPONENT_FEATURE, 0, 10);

	set_eval_packing((*P)[0].EVAL_S8, T, kd_S10 + 2, 0, 0, 0, 8);	/* 8 squares : 6561 -> 3321 */
	for (j = 0; j < 6561; ++j)
		(*P)[1].EVAL_S8[j] = (*P)[0].EVAL_S8[OPPONENT_FEATURE[j + 26244]];	// 1100000000(3)

	set_eval_packing((*P)[0].EVAL_S7, T, kd_S10 + 3, 0, 0, 0, 7);	/* 7 squares : 2187 -> 1134 */
	for (j = 0; j < 2187; ++j)
		(*P)[1].EVAL_S7[j] = (*P)[0].EVAL_S7[OPPONENT_FEATURE[j + 28431]];	// 1110000000(3)

	set_eval_packing((*P)[0].EVAL_S6, T, kd_S10 + 4, 0, 0, 0, 6);	/* 6 squares : 729 -> 378 */
	for (j = 0; j < 729; ++j)
		(*P)[1].EVAL_S6[j] = (*P)[0].EVAL_S6[OPPONENT_FEATURE[j + 29160]];	// 1111000000(3)

	set_eval_packing((*P)[0].EVAL_S5, T, kd_S10 + 5, 0, 0, 0, 5);	/* 5 squares : 243 -> 135 */
	for (j = 0; j < 243; ++j)
		(*P)[1].EVAL_S5[j] = (*P)[0].EVAL_S5[OPPONENT_FEATURE[j + 29403]];	// 1111100000(3)

	set_eval_packing((*P)[0].EVAL_S4, T, kd_S10 + 6, 0, 0, 0, 4);	/* 4 squares : 81 -> 45 */
	for (j = 0; j < 81; ++j)
		(*P)[1].EVAL_S4[j] = (*P)[0].EVAL_S4[OPPONENT_FEATURE[j + 29484]];	// 1111110000(3)

	set_eval_packing((*P)[0].EVAL_C9, T, kd_C9, 0, 0, 0, 9);	/* 9 corner squares : 19683 -> 10206 */
	for (j = 0; j < 19683; ++j)
		(*P)[1].EVAL_C9[j] = (*P)[0].EVAL_C9[OPPONENT_FEATURE[j + 19683]];	// 1000000000(3)

	set_eval_packing((*P)[0].EVAL_S10, T, kd_S10, 0, 0, 0, 10);	/* 10 squares (edge + X) : 59049 -> 29646 */
	set_eval_packing((*P)[0].EVAL_C10, T, kd_C10, 0, 0, 0, 10);	/* 10 squares (angle + X) : 59049 -> 29889 */
	for (j = 0; j < 59049; ++j) {
		(*P)[1].EVAL_S10[j] = (*P)[0].EVAL_S10[OPPONENT_FEATURE[j]];
		(*P)[1].EVAL_C10[j] = (*P)[0].EVAL_C10[OPPONENT_FEATURE[j]];
	}

	free(T);

	// allocation
	EVAL_WEIGHT = (Eval_weight(*)[EVAL_N_PLY - 2]) malloc(sizeof(*EVAL_WEIGHT));
	if (EVAL_WEIGHT == NULL) fatal_error("Cannot allocate evaluation weights.\n");

	// data reading
	w = (short*) malloc(n_w * sizeof (*w)); // a temporary to read packed weights
	f = fopen(file, "rb");
	if (f == NULL) {
		fprintf(stderr, "Cannot open %s", file);
		exit(EXIT_FAILURE);
	}

	// File header
	r = fread(&edax_header, sizeof (int), 1, f);
	r += fread(&eval_header, sizeof (int), 1, f);
	if (r != 2 || (!(edax_header == EDAX || eval_header == EVAL) && !(edax_header == XADE || eval_header == LAVE))) fatal_error("%s is not an Edax evaluation file\n", file);
	r = fread(&version, sizeof (int), 1, f);
	r += fread(&release, sizeof (int), 1, f);
	r += fread(&build, sizeof (int), 1, f);
	r += fread(&date, sizeof (double), 1, f);
	if (r != 4) fatal_error("Cannot read version info from %s\n", file);
	if (edax_header == XADE) {
		version = bswap_int(version);
		release = bswap_int(release);
		build = bswap_int(build);
	}
	// Weights : read & unpacked them
	for (ply = 0; ply < EVAL_N_PLY; ply++) {
		r = fread(w, sizeof (short), n_w, f);
		if (r != n_w) fatal_error("Cannot read evaluation weight from %s\n", file);
		if (ply < 2) continue;	// skip ply 1 & 2

		if (edax_header == XADE) for (i = 0; i < n_w; ++i) w[i] = bswap_short(w[i]);

		pe = *EVAL_WEIGHT + ply - 2;
		pp = *P + (ply & 1);
		for (k = 0; k < 19683; k++) {
			pe->C9[k] = w[pp->EVAL_C9[k] + EVAL_PACKED_OFS[0]];
		}
		for (k = 0; k < 59049; k++) {
			pe->C10[k] = w[pp->EVAL_C10[k] + EVAL_PACKED_OFS[1]];
			i = pp->EVAL_S10[k];
			pe->S100[k] = w[i + EVAL_PACKED_OFS[2]];
			pe->S101[k] = w[i + EVAL_PACKED_OFS[3]];
		}
		for (k = 0; k < 6561; k++) {
			i = pp->EVAL_S8[k];
			pe->S8x4[k] = w[i + EVAL_PACKED_OFS[4]];
			pe->S8x4[k + 6561] = w[i + EVAL_PACKED_OFS[5]];
			pe->S8x4[k + 13122] = w[i + EVAL_PACKED_OFS[6]];
			pe->S8x4[k + 19683] = w[i + EVAL_PACKED_OFS[7]];
		}
		for (k = 0; k < 2187; k++) {
			pe->S7654[k] = w[pp->EVAL_S7[k] + EVAL_PACKED_OFS[8]];
		}
		for (k = 0; k < 729; k++) {
			pe->S7654[k + 2187] = w[pp->EVAL_S6[k] + EVAL_PACKED_OFS[9]];
		}
		for (k = 0; k < 243; k++) {
			pe->S7654[k + 2916] = w[pp->EVAL_S5[k] + EVAL_PACKED_OFS[10]];
		}
		for (k = 0; k < 81; k++) {
			pe->S7654[k + 3159] = w[pp->EVAL_S4[k] + EVAL_PACKED_OFS[11]];
		}
		pe->S0 = w[EVAL_PACKED_OFS[12]];
	}

	fclose(f);
	free(w);
	free(P);

	/*if (version == 3 && release == 2 && build == 5)*/ {
		EVAL_A = -0.10026799, EVAL_B = 0.31027733, EVAL_C = -0.57772603;
		EVAL_a = 0.07585621, EVAL_b = 1.16492647, EVAL_c = 5.4171698;
	}

	info("<Evaluation function weights version %u.%u.%u loaded>\n", version, release, build);

	// f = fopen("eval.bin", "wb");
	// fwrite(*EVAL_WEIGHT, sizeof(Eval_weight), EVAL_N_PLY, f);
	// fclose(f);
}

/**
 * @brief Free global resources allocated to the evaluation function.
 */
void eval_close(void)
{
	free(OPPONENT_FEATURE);
	free(EVAL_WEIGHT);
	EVAL_WEIGHT = NULL;
}

#ifdef ANDROID
extern void eval_update_sse(int x, unsigned long long f, Eval *eval_out, const Eval *eval_in);
#elif defined(hasSSE2) || defined(__ARM_NEON) || defined(USE_GAS_MMX) || defined(USE_MSVC_X86)
#include "eval_sse.c"
#endif

#if !defined(hasSSE2) && !defined(__ARM_NEON)

/**
 * @brief Set up evaluation features from a board.
 *
 * @param eval  Evaluation function.
 * @param board Board to setup features from.
 */
void eval_set(Eval *eval, const Board *board)
{
	int	i, x;
  #ifdef VECTOR_EVAL_UPDATE
	unsigned long long b = (eval->n_empties & 1) ? board->opponent : board->player;

	eval->feature = EVAL_FEATURE_all_opponent;
	foreach_bit (x, b)
		for (i = 0; i < 12; ++i)
			eval->feature.ull[i] -= EVAL_FEATURE[x].ull[i];

	b = ~(board->opponent | board->player);
	foreach_bit (x, b)
		for (i = 0; i < 12; ++i)
			eval->feature.ull[i] += EVAL_FEATURE[x].ull[i];

  #else
	int	j;
	Board	b;

	if (eval->n_empties & 1) {
		b.player = board->opponent;
		b.opponent = board->player;
	} else	b = *board;

	for (i = 0; i < EVAL_N_FEATURE; ++i) {
		x = 0;
		for (j = 0; j < EVAL_F2X[i].n_square; j++) {
			x = x * 3 + board_get_square_color(&b, EVAL_F2X[i].x[j]);
		}
		eval->feature.us[i] = x + EVAL_OFFSET[i];
	}
  #endif
}

/**
 * @brief Update the features after a player's move.
 *
 * @param x     Move position.
 * @param f     Flipped bitboard.
 * @param eval  Evaluation function.
 */
static void eval_update_0(int x, unsigned long long f, Eval *eval)
{
  #ifdef VECTOR_EVAL_UPDATE
	int	i;

	for (i = 0; i < 12; ++i)
		eval->feature.ull[i] -= EVAL_FEATURE[x].ull[i] << 1;

	foreach_bit (x, f)
		for (i = 0; i < 12; ++i)
			eval->feature.ull[i] -= EVAL_FEATURE[x].ull[i];

  #else
	const CoordinateToFeature *s = EVAL_X2F + x;

	switch (s->n_feature) {
	default:
		eval->feature.us[s->feature[6].i] -= 2 * s->feature[6].x;	// FALLTHRU
	case 6:	eval->feature.us[s->feature[5].i] -= 2 * s->feature[5].x;	// FALLTHRU
	case 5:	eval->feature.us[s->feature[4].i] -= 2 * s->feature[4].x;	// FALLTHRU
	case 4:	eval->feature.us[s->feature[3].i] -= 2 * s->feature[3].x;
		eval->feature.us[s->feature[2].i] -= 2 * s->feature[2].x;
		eval->feature.us[s->feature[1].i] -= 2 * s->feature[1].x;
		eval->feature.us[s->feature[0].i] -= 2 * s->feature[0].x;
		break;
	}

	foreach_bit (x, f) {
		s = EVAL_X2F + x;
		switch (s->n_feature) {
		default:
			eval->feature.us[s->feature[6].i] -= s->feature[6].x;	// FALLTHRU
		case 6:	eval->feature.us[s->feature[5].i] -= s->feature[5].x;	// FALLTHRU
		case 5:	eval->feature.us[s->feature[4].i] -= s->feature[4].x;	// FALLTHRU
		case 4:	eval->feature.us[s->feature[3].i] -= s->feature[3].x;
			eval->feature.us[s->feature[2].i] -= s->feature[2].x;
			eval->feature.us[s->feature[1].i] -= s->feature[1].x;
			eval->feature.us[s->feature[0].i] -= s->feature[0].x;
			break;
		}
	}
  #endif
}

/**
 * @brief Update the features after a player's move.
 *
 * @param x     Move position.
 * @param f     Flipped bitboard.
 * @param eval  Evaluation function.
 */
static void eval_update_1(int x, unsigned long long f, Eval *eval)
{
  #ifdef VECTOR_EVAL_UPDATE
	int	i;

	for (i = 0; i < 12; ++i)
		eval->feature.ull[i] -= EVAL_FEATURE[x].ull[i];

	foreach_bit (x, f)
		for (i = 0; i < 12; ++i)
			eval->feature.ull[i] += EVAL_FEATURE[x].ull[i];

  #else
	const CoordinateToFeature *s = EVAL_X2F + x;

	switch (s->n_feature) {
	default:
	       	eval->feature.us[s->feature[6].i] -= s->feature[6].x;	// FALLTHRU
	case 6:	eval->feature.us[s->feature[5].i] -= s->feature[5].x;	// FALLTHRU
	case 5:	eval->feature.us[s->feature[4].i] -= s->feature[4].x;	// FALLTHRU
	case 4:	eval->feature.us[s->feature[3].i] -= s->feature[3].x;
	       	eval->feature.us[s->feature[2].i] -= s->feature[2].x;
	       	eval->feature.us[s->feature[1].i] -= s->feature[1].x;
	       	eval->feature.us[s->feature[0].i] -= s->feature[0].x;
	       	break;
	}

	foreach_bit (x, f) {
		s = EVAL_X2F + x;
		switch (s->n_feature) {
		default:
		       	eval->feature.us[s->feature[6].i] += s->feature[6].x;	// FALLTHRU
		case 6:	eval->feature.us[s->feature[5].i] += s->feature[5].x;	// FALLTHRU
		case 5:	eval->feature.us[s->feature[4].i] += s->feature[4].x;	// FALLTHRU
		case 4:	eval->feature.us[s->feature[3].i] += s->feature[3].x;
		       	eval->feature.us[s->feature[2].i] += s->feature[2].x;
		       	eval->feature.us[s->feature[1].i] += s->feature[1].x;
		       	eval->feature.us[s->feature[0].i] += s->feature[0].x;
		       	break;
		}
	}
  #endif
}

void eval_update(int x, unsigned long long f, Eval *eval)
{
	assert(f);

  #if defined(USE_GAS_MMX) || defined(USE_MSVC_X86) || defined(DISPATCH_NEON)
	if (hasSSE2) {
		eval_update_sse(x, f, eval, eval);
		return;
	}
  #endif
	if (eval->n_empties & 1)
		eval_update_1(x, f, eval);
	else
		eval_update_0(x, f, eval);
}

void eval_update_leaf(int x, unsigned long long f, Eval *eval_out, const Eval *eval_in)
{
  #if defined(USE_GAS_MMX) || defined(USE_MSVC_X86) || defined(DISPATCH_NEON)
	if (hasSSE2) {
		eval_update_sse(x, f, eval_out, eval_in);
		return;
	}
  #endif
	eval_out->feature = eval_in->feature;
	if (eval_in->n_empties & 1)
		eval_update_1(x, f, eval_out);
	else
		eval_update_0(x, f, eval_out);
}

#endif // !defined(hasSSE2) && !defined(__ARM_NEON)

/**
 * @brief Update/Restore the features after a passing move.
 *
 * @param eval  Evaluation function.
 */
void eval_pass(Eval *eval)
{
	int i;

	for (i =  0; i <  4; ++i)	// 9
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i] + 19683];
	for (i =  4; i < 16; ++i)	// 10
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i]];
	for (i = 16; i < 30; ++i)	// 8
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i] - EVAL_OFFSET[i] + 26244] + EVAL_OFFSET[i];
	for (i = 30; i < 34; ++i)	// 7
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i] + 28431];
	for (i = 34; i < 38; ++i)	// 6
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i] - 2187 + 29160] + 2187;
	for (i = 38; i < 42; ++i)	// 5
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i] - 2916 + 29403] + 2916;
	for (i = 42; i < 46; ++i)	// 4
		eval->feature.us[i] = OPPONENT_FEATURE[eval->feature.us[i] - 3159 + 29484] + 3159;
}

/**
 * @brief Compute the error-type of the evaluation function according to the
 * depths.
 *
 * A statistical study showed that the accuracy of the alphabeta
 * mostly depends on the depth & the ply of the game. This function is useful
 * to the probcut algorithm. Using a function instead of a table of data makes
 * easier to inter- or extrapolate new values.
 *
 * @param n_empty Number of empty squares on the board.
 * @param depth Depth used in alphabeta.
 * @param probcut_depth A shallow depth used in probcut algorithm.
 */
double eval_sigma(const int n_empty, const int depth, const int probcut_depth)
{
	double sigma;

	sigma = EVAL_A * n_empty + EVAL_B * depth + EVAL_C * probcut_depth;
	sigma = EVAL_a * sigma * sigma + EVAL_b * sigma + EVAL_c;

	return sigma;
}
